<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continuous Improvement - Complete Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: #1976d2;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .demo-badge {
            background: #ffc107;
            color: #1976d2;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Login Box */
        .login-container {
            max-width: 450px;
            margin: 30px auto;
        }
        
        .login-box {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .login-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .info-box {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            font-size: 14px;
            color: #0d47a1;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group label .required {
            color: #d32f2f;
            margin-left: 4px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #1976d2;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Money Input */
        .money-input {
            position: relative;
        }
        
        .money-input .prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: 500;
        }
        
        .money-input input {
            padding-left: 40px;
        }
        
        /* File Upload */
        .upload-container {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            background: #fafafa;
        }
        
        .upload-container:hover {
            border-color: #1976d2;
            background: #e3f2fd;
        }
        
        .upload-container .camera-icon {
            font-size: 48px;
            margin-bottom: 10px;
            display: block;
        }
        
        .upload-container p {
            color: #666;
            margin-bottom: 5px;
        }
        
        .upload-container small {
            color: #999;
            font-size: 12px;
        }
        
        .preview-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .preview-item {
            flex: 1;
            min-width: 250px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            background: white;
        }
        
        .preview-item .preview-label {
            background: #f5f5f5;
            padding: 10px;
            font-weight: 500;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .preview-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        
        .preview-item .no-image {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            color: #999;
        }
        
        .remove-image {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px;
            width: 100%;
            cursor: pointer;
            font-size: 13px;
        }
        
        .remove-image:hover {
            background: #c82333;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1976d2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1565c0;
        }
        
        .btn-success {
            background: #2e7d32;
            color: white;
        }
        
        .btn-success:hover {
            background: #1b5e20;
        }
        
        .btn-danger {
            background: #d32f2f;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b71c1c;
        }
        
        .btn-secondary {
            background: #757575;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #616161;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .role-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .role-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .role-btn:hover {
            background: #e0e0e0;
            border-color: #1976d2;
        }
        
        /* Dashboard */
        .dashboard {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
        }
        
        .user-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-detail {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .user-role {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .create-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .create-form h3 {
            margin-bottom: 25px;
            color: #333;
            font-size: 20px;
        }
        
        /* Form Sections */
        .form-section {
            background: white;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .form-section h4 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-section h4:before {
            content: 'üìã';
            font-size: 18px;
        }
        
        .form-section:nth-child(2) h4:before {
            content: 'üí∞';
        }
        
        .form-section:nth-child(3) h4:before {
            content: 'üì∏';
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Photo Gallery in Cards */
        .photo-gallery {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .photo-item {
            flex: 1;
            min-width: 200px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .photo-item .photo-label {
            background: #f5f5f5;
            padding: 8px;
            font-weight: 500;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .photo-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
            cursor: pointer;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 25px;
        }
        
        .tab {
            padding: 12px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #757575;
            position: relative;
        }
        
        .tab.active {
            color: #1976d2;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #1976d2;
        }
        
        /* Cards */
        .improvement-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
        }
        
        .improvement-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #e65100;
        }
        
        .status-approved {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-rejected {
            background: #ffebee;
            color: #c62828;
        }
        
        .card-meta {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px 0;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .meta-item {
            color: #666;
        }
        
        .meta-item strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }
        
        .cost-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .cost-row:last-child {
            border-bottom: none;
        }
        
        .cost-label {
            color: #666;
        }
        
        .cost-value {
            font-weight: 600;
            color: #2e7d32;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            position: sticky;
            top: 0;
        }
        
        .modal-header h3 {
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .info-display {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .info-display p {
            margin: 10px 0;
            color: #333;
        }
        
        .hidden {
            display: none;
        }
        
        .flex {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #757575;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Continuous Improvement Monitoring</h1>
            <span class="demo-badge">DEMO</span>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-container">
            <div class="login-box">
                <div class="login-header">
                    <h2>Login</h2>
                </div>
                <div class="login-body">
                    <div class="info-box">
                        <strong>üîê Demo Credentials:</strong><br>
                        Staff: staff@demo.com / staff123<br>
                        Manager: manager@demo.com / manager123<br>
                        Director: director@demo.com / director123
                    </div>

                    <form id="loginForm">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email" class="form-control" value="staff@demo.com" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="password" class="form-control" value="staff123" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                    </form>

                    <div class="role-buttons">
                        <button type="button" class="role-btn" onclick="fillLogin('staff@demo.com', 'staff123')">Staff</button>
                        <button type="button" class="role-btn" onclick="fillLogin('manager@demo.com', 'manager123')">Manager</button>
                        <button type="button" class="role-btn" onclick="fillLogin('director@demo.com', 'director123')">Director</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard hidden">
            <!-- User Info -->
            <div class="user-info">
                <div class="user-detail">
                    <span class="user-name" id="userName"></span>
                    <span class="user-role" id="userRole"></span>
                </div>
                <button onclick="logout()" class="btn btn-danger btn-small">Logout</button>
            </div>

            <!-- Create Button -->
            <button onclick="showCreateForm()" class="btn btn-success" style="margin-bottom: 20px;">
                + Buat Improvement Baru
            </button>

            <!-- Create Form -->
            <div id="createForm" class="create-form hidden">
                <h3>Form Improvement Baru</h3>
                <form id="improvementForm">
                    <!-- Section 1: Identifikasi Masalah -->
                    <div class="form-section">
                        <h4>Identifikasi Masalah</h4>
                        
                        <div class="form-group">
                            <label>Judul Improvement <span class="required">*</span></label>
                            <input type="text" id="title" class="form-control" placeholder="Contoh: Optimasi Proses Produksi" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Jelaskan Permasalahan yang Ada <span class="required">*</span></label>
                            <textarea id="problem" class="form-control" placeholder="Deskripsikan permasalahan yang ditemukan..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Jelaskan Penanggulangan <span class="required">*</span></label>
                            <textarea id="solution" class="form-control" placeholder="Jelaskan bagaimana cara menanggulangi masalah..." required></textarea>
                        </div>
                    </div>

                    <!-- Section 2: Biaya dan Cost Saving -->
                    <div class="form-section">
                        <h4>Biaya & Cost Saving</h4>
                        
                        <div class="row">
                            <div class="form-group">
                                <label>Biaya Penanggulangan <span class="required">*</span></label>
                                <div class="money-input">
                                    <span class="prefix">Rp</span>
                                    <input type="number" id="cost" class="form-control" placeholder="0" min="0" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Cost Saving <span class="required">*</span></label>
                                <div class="money-input">
                                    <span class="prefix">Rp</span>
                                    <input type="number" id="saving" class="form-control" placeholder="0" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Jelaskan Rincian Biaya Penanggulangan <span class="required">*</span></label>
                            <textarea id="costDetails" class="form-control" placeholder="Rincikan biaya-biaya yang diperlukan..." rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Jelaskan Cost Saving <span class="required">*</span></label>
                            <textarea id="savingDetails" class="form-control" placeholder="Jelaskan bagaimana cost saving bisa tercapai..." rows="3" required></textarea>
                        </div>
                    </div>

                    <!-- Section 3: Dokumentasi Foto -->
                    <div class="form-section">
                        <h4>Dokumentasi Foto</h4>
                        
                        <!-- Upload Foto Before -->
                        <div class="form-group">
                            <label>Foto Before (Kondisi Awal) <span class="required">*</span></label>
                            <div class="upload-container" onclick="document.getElementById('fileBefore').click()">
                                <span class="camera-icon">üì∏</span>
                                <p>Klik untuk upload foto atau gunakan kamera</p>
                                <small>Format: JPG, PNG (Max 5MB)</small>
                            </div>
                            <input type="file" id="fileBefore" accept="image/*" capture="environment" class="hidden" onchange="previewBefore(event)">
                            <div id="previewBefore" class="preview-container"></div>
                        </div>

                        <!-- Upload Foto After -->
                        <div class="form-group">
                            <label>Foto After (Kondisi Setelah Improvement) <span class="required">*</span></label>
                            <div class="upload-container" onclick="document.getElementById('fileAfter').click()">
                                <span class="camera-icon">üì∏</span>
                                <p>Klik untuk upload foto atau gunakan kamera</p>
                                <small>Format: JPG, PNG (Max 5MB)</small>
                            </div>
                            <input type="file" id="fileAfter" accept="image/*" capture="environment" class="hidden" onchange="previewAfter(event)">
                            <div id="previewAfter" class="preview-container"></div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex" style="justify-content: flex-end; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">Submit Improvement</button>
                        <button type="button" onclick="hideCreateForm()" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" id="pendingTab" onclick="loadData('pending')">Pending Approval</button>
                <button class="tab" id="myTab" onclick="loadData('my')">Improvement Saya</button>
                <button class="tab" id="allTab" onclick="loadData('all')">Semua Improvement</button>
            </div>

            <!-- Improvements List -->
            <div id="improvementsList"></div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div id="approvalModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Approval Improvement</h3>
            </div>
            <div class="modal-body">
                <div class="info-display" id="modalInfo"></div>
                
                <!-- Foto di Modal Approval -->
                <div id="modalPhotos" class="photo-gallery"></div>
                
                <div class="form-group">
                    <label>Keputusan</label>
                    <select id="approvalAction" class="form-control">
                        <option value="approved">Approve</option>
                        <option value="rejected">Reject</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Komentar</label>
                    <textarea id="approvalComments" class="form-control" rows="3" placeholder="Tambahkan komentar..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="submitApproval()" class="btn btn-primary">Submit</button>
                <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detail Improvement</h3>
            </div>
            <div class="modal-body">
                <div id="detailInfo" class="info-display"></div>
                <div id="detailPhotos" class="photo-gallery"></div>
                <div id="detailCost" class="cost-info"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeDetailModal()" class="btn btn-primary">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Data Store
        let currentUser = null;
        let currentImprovementId = null;
        
        let improvements = [
            {
                id: '1',
                title: 'Optimasi Proses Produksi',
                problem: 'Mesin sering idle dan banyak waktu tunggu antar proses',
                solution: 'Re-layout production line dan implementasi sistem kanban',
                cost: 5000000,
                costDetails: 'Biaya konsultan: Rp 3.000.000, Material: Rp 2.000.000',
                saving: 15000000,
                savingDetails: 'Efisiensi waktu 20% = Rp 10.000.000/bulan, Reduksi waste = Rp 5.000.000/bulan',
                category: 'process',
                proposerId: 'staff1',
                proposerName: 'Staff Demo',
                proposerRole: 'staff',
                status: 'pending',
                currentLevel: 1,
                maxLevel: 2,
                createdAt: new Date().toISOString(),
                photoBefore: null,
                photoAfter: null
            },
            {
                id: '2',
                title: 'Reduksi Waste Material',
                problem: 'Scrap rate tinggi mencapai 15%',
                solution: 'Implementasi metode lean manufacturing dan training operator',
                cost: 2000000,
                costDetails: 'Training: Rp 1.500.000, Tools: Rp 500.000',
                saving: 8000000,
                savingDetails: 'Scrap turun 10% = Rp 8.000.000/bulan',
                category: 'cost',
                proposerId: 'staff1',
                proposerName: 'Staff Demo',
                proposerRole: 'staff',
                status: 'approved',
                currentLevel: 2,
                maxLevel: 2,
                createdAt: new Date(Date.now() - 86400000).toISOString(),
                photoBefore: null,
                photoAfter: null
            }
        ];

        // File Upload State
        let photoBeforeData = null;
        let photoAfterData = null;

        // Helper Functions
        window.fillLogin = function(email, password) {
            document.getElementById('email').value = email;
            document.getElementById('password').value = password;
        };

        // Preview Functions
        window.previewBefore = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoBeforeData = e.target.result;
                    document.getElementById('previewBefore').innerHTML = `
                        <div class="preview-item">
                            <div class="preview-label">Foto Before</div>
                            <img src="${e.target.result}" alt="Preview Before">
                            <button type="button" class="remove-image" onclick="removeBefore()">Hapus Foto</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        };

        window.previewAfter = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoAfterData = e.target.result;
                    document.getElementById('previewAfter').innerHTML = `
                        <div class="preview-item">
                            <div class="preview-label">Foto After</div>
                            <img src="${e.target.result}" alt="Preview After">
                            <button type="button" class="remove-image" onclick="removeAfter()">Hapus Foto</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeBefore = function() {
            photoBeforeData = null;
            document.getElementById('previewBefore').innerHTML = '';
            document.getElementById('fileBefore').value = '';
        };

        window.removeAfter = function() {
            photoAfterData = null;
            document.getElementById('previewAfter').innerHTML = '';
            document.getElementById('fileAfter').value = '';
        };

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === 'staff@demo.com' && password === 'staff123') {
                currentUser = {
                    id: 'staff1',
                    name: 'Staff Demo',
                    role: 'staff'
                };
            } else if (email === 'manager@demo.com' && password === 'manager123') {
                currentUser = {
                    id: 'manager1',
                    name: 'Manager Demo',
                    role: 'manager'
                };
            } else if (email === 'director@demo.com' && password === 'director123') {
                currentUser = {
                    id: 'director1',
                    name: 'Director Demo',
                    role: 'director'
                };
            } else {
                alert('Email atau password salah!');
                return;
            }

            // Update UI
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
            
            loadData('pending');
        });

        // Logout
        window.logout = function() {
            currentUser = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        };

        // Create Improvement
        document.getElementById('improvementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form values
            const title = document.getElementById('title').value;
            const problem = document.getElementById('problem').value;
            const solution = document.getElementById('solution').value;
            const cost = parseFloat(document.getElementById('cost').value) || 0;
            const costDetails = document.getElementById('costDetails').value;
            const saving = parseFloat(document.getElementById('saving').value) || 0;
            const savingDetails = document.getElementById('savingDetails').value;

            // Validation
            if (!title || !problem || !solution || !cost || !costDetails || !saving || !savingDetails) {
                alert('Semua field harus diisi!');
                return;
            }

            if (!photoBeforeData || !photoAfterData) {
                alert('Foto before dan after harus diupload!');
                return;
            }

            const newImprovement = {
                id: Date.now().toString(),
                title: title,
                problem: problem,
                solution: solution,
                cost: cost,
                costDetails: costDetails,
                saving: saving,
                savingDetails: savingDetails,
                category: document.getElementById('category').value,
                proposerId: currentUser.id,
                proposerName: currentUser.name,
                proposerRole: currentUser.role,
                status: 'pending',
                currentLevel: 1,
                maxLevel: 2,
                createdAt: new Date().toISOString(),
                photoBefore: photoBeforeData,
                photoAfter: photoAfterData
            };

            improvements.unshift(newImprovement);
            
            alert('Improvement berhasil dibuat!');
            
            // Reset form
            hideCreateForm();
            removeBefore();
            removeAfter();
            
            loadData('my');
        });

        window.showCreateForm = function() {
            document.getElementById('createForm').classList.remove('hidden');
        };

        window.hideCreateForm = function() {
            document.getElementById('createForm').classList.add('hidden');
            document.getElementById('improvementForm').reset();
            removeBefore();
            removeAfter();
        };

        // Load Data
        window.loadData = function(type) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(type + 'Tab').classList.add('active');

            let filtered = [];
            
            if (type === 'my') {
                filtered = improvements.filter(imp => imp.proposerId === currentUser.id);
            } else if (type === 'pending') {
                if (currentUser.role === 'manager') {
                    filtered = improvements.filter(imp => imp.status === 'pending' && imp.currentLevel === 1);
                } else if (currentUser.role === 'director') {
                    filtered = improvements.filter(imp => imp.status === 'pending' && imp.currentLevel === 2);
                } else {
                    filtered = improvements.filter(imp => imp.status === 'pending');
                }
            } else {
                filtered = improvements;
            }

            displayImprovements(filtered);
        };

        function formatRupiah(amount) {
            return 'Rp ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function displayImprovements(items) {
            const container = document.getElementById('improvementsList');
            
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state">Tidak ada improvement ditemukan</div>';
                return;
            }

            container.innerHTML = items.map(item => {
                const hasPhotos = item.photoBefore || item.photoAfter;
                
                return `
                <div class="improvement-card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${item.title}</div>
                            <p style="color: #666;">${item.problem}</p>
                        </div>
                        <span class="status-badge status-${item.status}">${item.status}</span>
                    </div>
                    
                    ${hasPhotos ? `
                        <div class="photo-gallery">
                            ${item.photoBefore ? `
                                <div class="photo-item">
                                    <div class="photo-label">Before</div>
                                    <img src="${item.photoBefore}" alt="Before" onclick="openDetail('${item.id}')">
                                </div>
                            ` : ''}
                            ${item.photoAfter ? `
                                <div class="photo-item">
                                    <div class="photo-label">After</div>
                                    <img src="${item.photoAfter}" alt="After" onclick="openDetail('${item.id}')">
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <div class="cost-info">
                        <div class="cost-row">
                            <span class="cost-label">Biaya Penanggulangan:</span>
                            <span class="cost-value">${formatRupiah(item.cost)}</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Cost Saving:</span>
                            <span class="cost-value">${formatRupiah(item.saving)}</span>
                        </div>
                    </div>
                    
                    <div class="card-meta">
                        <div class="meta-item">
                            <strong>Kategori</strong>
                            ${item.category}
                        </div>
                        <div class="meta-item">
                            <strong>Pembuat</strong>
                            ${item.proposerName}
                        </div>
                        <div class="meta-item">
                            <strong>Tanggal</strong>
                            ${new Date(item.createdAt).toLocaleDateString('id-ID')}
                        </div>
                        <div class="meta-item">
                            <strong>Level</strong>
                            ${item.currentLevel}/${item.maxLevel}
                        </div>
                    </div>

                    <div class="flex">
                        ${canApprove(item) ? `
                            <button onclick="openApprovalModal('${item.id}')" class="btn btn-primary btn-small">
                                Review & Approve
                            </button>
                        ` : ''}
                        <button onclick="openDetail('${item.id}')" class="btn btn-secondary btn-small">
                            Lihat Detail
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function canApprove(item) {
            if (!currentUser || item.status !== 'pending') return false;
            if (currentUser.role === 'manager' && item.currentLevel === 1) return true;
            if (currentUser.role === 'director' && item.currentLevel === 2) return true;
            return false;
        }

        // Detail Modal
        window.openDetail = function(id) {
            const item = improvements.find(i => i.id === id);
            
            document.getElementById('detailInfo').innerHTML = `
                <h4 style="margin-bottom: 15px;">${item.title}</h4>
                <p><strong>Permasalahan:</strong><br>${item.problem}</p>
                <p><strong>Penanggulangan:</strong><br>${item.solution}</p>
            `;
            
            document.getElementById('detailPhotos').innerHTML = `
                ${item.photoBefore ? `
                    <div class="photo-item">
                        <div class="photo-label">Foto Before</div>
                        <img src="${item.photoBefore}" alt="Before">
                    </div>
                ` : ''}
                ${item.photoAfter ? `
                    <div class="photo-item">
                        <div class="photo-label">Foto After</div>
                        <img src="${item.photoAfter}" alt="After">
                    </div>
                ` : ''}
            `;
            
            document.getElementById('detailCost').innerHTML = `
                <h4 style="margin-bottom: 10px;">Rincian Biaya & Cost Saving</h4>
                <div class="cost-row">
                    <span class="cost-label">Biaya Penanggulangan:</span>
                    <span class="cost-value">${formatRupiah(item.cost)}</span>
                </div>
                <div class="cost-row">
                    <span class="cost-label">Rincian Biaya:</span>
                    <span>${item.costDetails}</span>
                </div>
                <div class="cost-row">
                    <span class="cost-label">Cost Saving:</span>
                    <span class="cost-value">${formatRupiah(item.saving)}</span>
                </div>
                <div class="cost-row">
                    <span class="cost-label">Rincian Cost Saving:</span>
                    <span>${item.savingDetails}</span>
                </div>
            `;
            
            document.getElementById('detailModal').classList.remove('hidden');
        };

        window.closeDetailModal = function() {
            document.getElementById('detailModal').classList.add('hidden');
        };

        // Approval Modal
        window.openApprovalModal = function(id) {
            currentImprovementId = id;
            const item = improvements.find(i => i.id === id);
            
            document.getElementById('modalInfo').innerHTML = `
                <p><strong>Judul:</strong> ${item.title}</p>
                <p><strong>Biaya:</strong> ${formatRupiah(item.cost)}</p>
                <p><strong>Cost Saving:</strong> ${formatRupiah(item.saving)}</p>
                <p><strong>Level Saat Ini:</strong> ${item.currentLevel}/${item.maxLevel}</p>
            `;
            
            document.getElementById('modalPhotos').innerHTML = `
                ${item.photoBefore ? `
                    <div class="photo-item">
                        <div class="photo-label">Before</div>
                        <img src="${item.photoBefore}" alt="Before">
                    </div>
                ` : ''}
                ${item.photoAfter ? `
                    <div class="photo-item">
                        <div class="photo-label">After</div>
                        <img src="${item.photoAfter}" alt="After">
                    </div>
                ` : ''}
            `;
            
            document.getElementById('approvalModal').classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('approvalModal').classList.add('hidden');
            document.getElementById('approvalComments').value = '';
        };

        window.submitApproval = function() {
            const action = document.getElementById('approvalAction').value;
            const comments = document.getElementById('approvalComments').value;
            
            const item = improvements.find(i => i.id === currentImprovementId);
            
            if (action === 'rejected') {
                item.status = 'rejected';
            } else {
                if (item.currentLevel >= item.maxLevel) {
                    item.status = 'approved';
                } else {
                    item.currentLevel++;
                }
            }

            alert(`Improvement berhasil di-${action === 'approved' ? 'approve' : 'reject'}!`);
            closeModal();
            
            const activeTab = document.querySelector('.tab.active').id.replace('Tab', '');
            loadData(activeTab);
        };
    </script>
</body>
</html>
